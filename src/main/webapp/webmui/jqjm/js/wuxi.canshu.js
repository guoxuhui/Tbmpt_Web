/**
 * 
 */
var jsonDanwei = [ {
	"dwid" : "TY_TJXT_0001",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TJXT_0002",
	"danwei" : "mm/min"
}, {
	"dwid" : "TY_TJXT_0003",
	"danwei" : "KN"
}, {
	"dwid" : "TY_TJXT_0004",
	"danwei" : "r/min"
}, {
	"dwid" : "TY_TJXT_0005",
	"danwei" : "KN•M"
}, {
	"dwid" : "TY_TJXT_0006",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TJXT_0007",
	"danwei" : "mm/rev"
}, {
	"dwid" : "TY_TJXT_0008",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TJXT_0009",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TJXT_0010",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TJXT_0011",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TJXT_0012",
	"danwei" : "mm"
}, {
	"dwid" : "TY_TJXT_0013",
	"danwei" : "mm"
}, {
	"dwid" : "TY_TJXT_0014",
	"danwei" : "mm"
}, {
	"dwid" : "TY_TJXT_0015",
	"danwei" : "mm"
}, {
	"dwid" : "TY_TJXT_0016",
	"danwei" : "KN"
}, {
	"dwid" : "TY_TJXT_0017",
	"danwei" : "m/s"
}, {
	"dwid" : "TY_TCYL_0001",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TCYL_0002",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TCYL_0003",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TCYL_0004",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TCYL_0005",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TCYL_0006",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TCYL_0007",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TCYL_0008",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TCYL_0009",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TCYL_0010",
	"danwei" : "bar"
}, {
	"dwid" : "TY_TCYL_0011",
	"danwei" : "bar"
}, {
	"dwid" : "TY_JJXT_0001",
	"danwei" : "mm"
}, {
	"dwid" : "TY_JJXT_0002",
	"danwei" : "mm"
}, {
	"dwid" : "TY_JJXT_0003",
	"danwei" : "mm"
}, {
	"dwid" : "TY_JJXT_0004",
	"danwei" : "mm"
}, {
	"dwid" : "TY_JJXT_0005",
	"danwei" : "bar"
}, {
	"dwid" : "TY_JJXT_0006",
	"danwei" : "bar"
}, {
	"dwid" : "TY_JJXT_0007",
	"danwei" : "bar"
}, {
	"dwid" : "TY_JJXT_0008",
	"danwei" : "bar"
}, {
	"dwid" : "TY_LXJ_0001",
	"danwei" : "r/min"
}, {
	"dwid" : "TY_LXJ_0002",
	"danwei" : "bar"
}, {
	"dwid" : "TY_LXJ_0003",
	"danwei" : "KN•M"
}, {
	"dwid" : "TY_LXJ_0004",
	"danwei" : "bar"
}, {
	"dwid" : "TY_LXJ_0005",
	"danwei" : "bar"
}, {
	"dwid" : "TY_LXJ_0006",
	"danwei" : "bar"
}, {
	"dwid" : "TY_LXJ_0007",
	"danwei" : "mm"
}, {
	"dwid" : "TY_LXJ_0008",
	"danwei" : "mm"
}, {
	"dwid" : "TY_PMXT_0001",
	"danwei" : "bar"
}, {
	"dwid" : "TY_PMXT_0002",
	"danwei" : "L/min"
}, {
	"dwid" : "TY_PMXT_0003",
	"danwei" : "L/min"
}, {
	"dwid" : "TY_PMXT_0004",
	"danwei" : "bar"
}, {
	"dwid" : "TY_PMXT_0005",
	"danwei" : "L/min"
}, {
	"dwid" : "TY_PMXT_0006",
	"danwei" : "L/min"
}, {
	"dwid" : "TY_PMXT_0007",
	"danwei" : "bar"
}, {
	"dwid" : "TY_PMXT_0008",
	"danwei" : "L/min"
}, {
	"dwid" : "TY_PMXT_0009",
	"danwei" : "L/min"
}, {
	"dwid" : "TY_PMXT_0010",
	"danwei" : "bar"
}, {
	"dwid" : "TY_PMXT_0011",
	"danwei" : "L/min"
}, {
	"dwid" : "TY_PMXT_0012",
	"danwei" : "L/min"
}, {
	"dwid" : "TY_PMXT_0013",
	"danwei" : "L/min"
}, {
	"dwid" : "TY_PMXT_0014",
	"danwei" : "L/min"
}, {
	"dwid" : "TY_ZJXT_0001",
	"danwei" : "bar"
}, {
	"dwid" : "TY_ZJXT_0002",
	"danwei" : "bar"
}, {
	"dwid" : "TY_ZJXT_0003",
	"danwei" : "bar"
}, {
	"dwid" : "TY_ZJXT_0004",
	"danwei" : "bar"
}, {
	"dwid" : "TY_ZJXT_0005",
	"danwei" : "Imp"
}, {
	"dwid" : "TY_ZJXT_0006",
	"danwei" : "Imp"
}, {
	"dwid" : "TY_ZJXT_0007",
	"danwei" : "Imp"
}, {
	"dwid" : "TY_ZJXT_0008",
	"danwei" : "Imp"
}, {
	"dwid" : "TY_ZJXT_0009",
	"danwei" : "bar"
}, {
	"dwid" : "TY_ZJXT_0010",
	"danwei" : "bar"
}, {
	"dwid" : "TY_ZJXT_0011",
	"danwei" : "bar"
}, {
	"dwid" : "TY_ZJXT_0012",
	"danwei" : "bar"
}, {
	"dwid" : "TY_ZJXT_0013",
	"danwei" : "Imp"
}, {
	"dwid" : "TY_ZJXT_0014",
	"danwei" : "Imp"
}, {
	"dwid" : "TY_ZJXT_0015",
	"danwei" : "Imp"
}, {
	"dwid" : "TY_ZJXT_0016",
	"danwei" : "Imp"
}, {
	"dwid" : "TY_ZJXT_0017",
	"danwei" : "Imp"
}, {
	"dwid" : "TY_DWYZ_0001",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0002",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0003",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0004",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0005",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0006",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0007",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0008",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0009",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0010",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0011",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0012",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0013",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0014",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0015",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0016",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0017",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0018",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0019",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0020",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0021",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0022",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0023",
	"danwei" : "bar"
}, {
	"dwid" : "TY_DWYZ_0024",
	"danwei" : "bar"
}, {
	"dwid" : "TY_YLJC_0001",
	"danwei" : "bar"
}, {
	"dwid" : "TY_YLJC_0002",
	"danwei" : "bar"
}, {
	"dwid" : "TY_YLJC_0003",
	"danwei" : "bar"
}, {
	"dwid" : "TY_YLJC_0004",
	"danwei" : "bar"
}, {
	"dwid" : "TY_YLJC_0005",
	"danwei" : "bar"
}, {
	"dwid" : "TY_YLJC_0006",
	"danwei" : "bar"
}, {
	"dwid" : "TY_WDJC_0001",
	"danwei" : "℃"
}, {
	"dwid" : "TY_WDJC_0002",
	"danwei" : "℃"
}, {
	"dwid" : "TY_WDJC_0003",
	"danwei" : "℃"
}, {
	"dwid" : "TY_WDJC_0004",
	"danwei" : "℃"
}, {
	"dwid" : "TY_DXXT_0001",
	"danwei" : ""
}, {
	"dwid" : "TY_DXXT_0002",
	"danwei" : "m"
}, {
	"dwid" : "TY_DXXT_0003",
	"danwei" : "mm/m"
}, {
	"dwid" : "TY_DXXT_0004",
	"danwei" : "mm/m"
}, {
	"dwid" : "TY_DXXT_0005",
	"danwei" : "mm"
}, {
	"dwid" : "TY_DXXT_0006",
	"danwei" : "mm"
}, {
	"dwid" : "TY_DXXT_0007",
	"danwei" : "mm"
}, {
	"dwid" : "TY_DXXT_0008",
	"danwei" : "mm"
}, {
	"dwid" : "TY_DXXT_0009",
	"danwei" : "mm/m"
}, {
	"dwid" : "TY_DXXT_0010",
	"danwei" : "mm/m"
}, {
	"dwid" : "TY_DXXT_0011",
	"danwei" : ""
}, {
	"dwid" : "TY_DXXT_0012",
	"danwei" : ""
}, {
	"dwid" : "TY_DXXT_0013",
	"danwei" : ""
}, {
	"dwid" : "TY_DXXT_0014",
	"danwei" : ""
}, {
	"dwid" : "TY_DXXT_0015",
	"danwei" : ""
}, {
	"dwid" : "TY_DXXT_0016",
	"danwei" : ""
}, {
	"dwid" : "TY_DXXT_0017",
	"danwei" : ""
} ];
function drawPlane(x1,y1,x2,y2){
    var c1 =document.getElementById("myCanvas");
    var ctx1 = c1.getContext("2d");
    //x1 = x1 * 1.5;
    //y1 = y1 * 1.5;
    //x2 = x2 * 1.5;
    //y2 = y2 * 1.5;
	 ///----------------------------飞机    开始--------------------------------------
	 /* var step = 250;
    var tX = step + startX, tY = step - startY;   //分机头控制
	 var eX = step + endX  , eY = step - endY;   //飞机尾部控制 308 361用来计算偏移量
	 var pX = eX - 308, pY = eY - 361;// px = 160+x2-308,py=160-y2-361;   偏移量
    ctx.globalAlpha=1;
    ctx.beginPath();//1
    ctx.fillStyle="#F2D761";
	 ctx.moveTo(tX,tY);
	 ctx.lineTo(step+28 + pX,step+67 -pY);
	 ctx.lineTo(step+48 + pX,step+81 -pY );
	 ctx.fill();
	 
	 ctx.beginPath();//2
    ctx.fillStyle="#D0983A";
	 ctx.moveTo(tX,tY);
	 ctx.lineTo(step+48 + pX,step+81 -pY);
	 ctx.lineTo(eX,eY);
	 ctx.fill();
	 
	 ctx.beginPath();//3
    ctx.fillStyle="#7A4A26";
	 ctx.moveTo(tX,tY);
	 ctx.lineTo(eX,eY);
	 ctx.lineTo(step+58 + pX,step+87 -pY);
	 ctx.fill();
	 
	 ctx.beginPath();//4
    ctx.fillStyle="#F3CC57";
	 ctx.moveTo(tX,tY);
	 ctx.lineTo(step+58 + pX,step+87 -pY);
	 ctx.lineTo(step+93 + pX,step+107-pY);
	 ctx.fill(); */
	 ////---------------------分机   结束----------------------------------
	 //知道开始坐标  在计算四个点
	 var step = 180;
	 var step1 = 30;//飞机尾部坐标的上下左右四个左边的偏移量
    var startX = step + x1, startY = step - y1; //(startX,startY)
    var endX = step + x2  , endY = step - y2;   //(endX,endY)
    var sX = endX,sY = endY - step1;//上
    var xX = endX,xY = endY + step1;//下
    var zX = endX -step1,zY = endY;//左点
    var yX = endX +step1,yY = endY;//右点
    
    ctx1.globalAlpha=1;
    ctx1.beginPath();//1 上点
    ctx1.fillStyle="#bfbfc1";
    ctx1.strokeStyle = 'blue'; 
    ctx1.lineWidth = 1;//线条的宽度
    ctx1.moveTo(startX,startY);
    ctx1.lineTo(endX,endY);
    ctx1.lineTo(xX,xY);
    ctx1.fill();
    ctx1.stroke();//绘制
	 
    ctx1.beginPath();//2下面点坐标
    ctx1.strokeStyle = 'blue'; 
    ctx1.fillStyle="#f4f4f4";
    ctx1.lineWidth = 1;//线条的宽度
    ctx1.moveTo(startX,startY);
    ctx1.lineTo(endX,endY);
    ctx1.lineTo(zX,zY);
    ctx1.fill();
    ctx1.stroke();//绘制
	 
    ctx1.beginPath();//3
    ctx1.fillStyle="#bfbfc1";
    ctx1.strokeStyle = 'blue';
    ctx1.lineWidth = 1;//线条的宽度
    ctx1.moveTo(startX,startY);
    ctx1.lineTo(endX,endY);
    ctx1.lineTo(sX,sY);
    ctx1.fill();
    ctx1.stroke();//绘制
	 
    ctx1.beginPath();//4
    ctx1.fillStyle="#f4f4f4";
    ctx1.lineWidth = 1;//线条的宽度
    ctx1.strokeStyle = 'blue'; 
    ctx1.moveTo(startX,startY);
    ctx1.lineTo(endX,endY);
    ctx1.lineTo(yX,yY);
    ctx1.fill(); 
    ctx1.stroke();//绘制
	 
	//canvas 是基于状态的绘制，而不是对象
    ctx1.beginPath();
    ctx1.moveTo(startX,startY);
    ctx1.lineTo(endX,endY);
    ctx1.lineWidth = 1;//线条的宽度
    ctx1.strokeStyle = "blue";//线条的颜色
    ctx1.stroke();//绘制
	 
}  
var flag = 0;
window.setInterval(function(){
	if(flag == 0){
		$('#dataConnect').text("【数据连接中...】");
	}else if(flag == 1){
		$('#dataConnect').text("【数据连接中....】");
	}else if(flag == 2){
		$('#dataConnect').text("【数据连接中.....】");
		timeDataConnection = 5000;
	}else if(flag == 3){
		$('#dataConnect').text("【数据正常】");
		flag = 0;
		timeDataConnection = 1000;
	}
	flag++;
}, 2000);

var teshuField = new Array("TY_WDJC_0001", "TY_WDJC_0002", "TY_WDJC_0003",
		"TY_WDJC_0004", "TY_GZZT_0001","TY_ZGZT_0001","TY_ZGZT_0002");

function changeWendu(id, value) {
	if(value == 'NaN'){
		value = 0;
	}
	$('#' +id).data('easyPieChart').update(value); 
	
}

var t = null, x1, y1, x2, y2;
var pinStatus,tingStatus,jueStatus; //盾构机的三种状态变量
t = setTimeout(time, 1000);// 开始执行
function time() {
	clearTimeout(t);// 清除定时器
	dt = new Date();
	var h = dt.getHours();
	var m = dt.getMinutes();
	var s = dt.getSeconds();
	var year = dt.getFullYear();//
	var month = dt.getMonth() + 1;
	;
	var date = dt.getDate();// 日数
	document.getElementById("time").innerHTML = year + "-" + month + "-" + date
			+ " " + h + ":" + m + ":" + s;
	t = setTimeout(time, 1000); // 设定定时器，循环执行
}
/**
 * 导向系统
 */
function  daoXiang()
{
	// daoQS  daoQC
	// daoHS  daoHC
	var daoQS = $('#TY_DXXT_0007').text(),daoQC = $('#TY_DXXT_0005').text(),daoHS = $('#TY_DXXT_0008').text(),daoHC = $('#TY_DXXT_0006').text();//导向系统的前后垂直、水平变量
	
	
	console.log("------>("+daoQS+","+daoQC+")("+daoHS+","+daoHC+")");
	drawCoordinate(360,360);
	drawPlane(parseFloat(daoQS),parseFloat(daoQC),parseFloat(daoHS),parseFloat(daoHC));
	//drawPlane(11.1,-104.5,-9.6,-123.2);
	
	//合计累计量
	var a = parseFloat($('#TY_ZJXT_0005').text()),
	b = parseFloat($('#TY_ZJXT_0006').text()),
	c = parseFloat($('#TY_ZJXT_0007').text()),
	d = parseFloat($('#TY_ZJXT_0008').text());
	var total = a+b+c+d;
	$('#leijiliang').text(total==0?"0.0":total);
}

$(window).load(
		function() {
			//parent.alertMsg.loading();
			showData();
			window.setInterval(showData, 30000);
			function findDanwei(id) {
				for (k = 0; k < jsonDanwei.length; k++) {
					if (jsonDanwei[k].dwid == id) {
						return jsonDanwei[k].danwei;
					}
				}

			}
			function showTeshuData(obj) {
				{
					console.log(obj.dwid + "   " + obj.tagvalue);
					//温度监测     开始
					if (obj.dwid == 'TY_WDJC_0001') {
						$('#TY_WDJC_0001').css('visibility','visible');
						changeWendu(obj.dwid, parseFloat(obj.tagvalue).toFixed(
								1));
					}
					if (obj.dwid == 'TY_WDJC_0002') {
						$('#TY_WDJC_0002').css('visibility','visible');
						changeWendu(obj.dwid, parseFloat(obj.tagvalue).toFixed(
								1));
					}
					if (obj.dwid == 'TY_WDJC_0003') {
						$('#TY_WDJC_0003').css('visibility','visible');
						changeWendu(obj.dwid, parseFloat(obj.tagvalue).toFixed(1));
					}
					if (obj.dwid == 'TY_WDJC_0004') {
						$('#TY_WDJC_0004').css('visibility','visible');
						changeWendu(obj.dwid, parseFloat(obj.tagvalue).toFixed(
								1));
					}
					//温度监测     结束
					//pinStatus,tingStatus,jueStatus;
					if (obj.dwid == 'TY_ZGZT_0001') {
						jueStatus = obj.tagvalue;
						if (obj.tagvalue == 'true') {
							$('#zhuangtai').text('掘进中');
						}
					}
					if (obj.dwid == 'TY_ZGZT_0002') {
						if (obj.tagvalue == 'true' && jueStatus == 'false') {
							$('#zhuangtai').text('拼装中');
						}else if(obj.tagvalue == 'false' && jueStatus == 'false'){
							$('#zhuangtai').text('停机中');
						}
						jueStatus = '';
					}

				}
			}
			function in_array(search, array) {
				for ( var i in array) {
					if (array[i] == search) {
						return true;
					}
				}
				return false;
			}

			
			function chuliData() {
				changeWendu('TY_WDJC_0001', '0');
				changeWendu('TY_WDJC_0004', '0');
			}
			/**
			 * 展示项目进本信息
			 */
			function showJbxxData() {
				$.ajax({
					url : "../../webmui/getProjectLineData",
					type : "POST",
					data : {
						_model : "2.1",
						appId : appId,
						appSecret : appSecret,
						xmId : xiangmuId,
						xlId : xianluId,
						t:Math.random()
					},
					dataType : 'json',
					success : function(jsonObj) {
						if (jsonObj.success) {
							jsonObj = jsonObj.obj;
							$('#xmMc').html(jsonObj.xmMc);
							$('#kgrq').html(jsonObj.kgrq);
							$('#fzr').html(jsonObj.fzr);
							$('#dgjczs').html(jsonObj.dgjczs);
							$('#dqdz').html(jsonObj.dqdz);
							
							$('#zydz').text(jsonObj.zydz );
							for(i=0;i<jsonObj.xlList.length;i++){
								var xianlObj = jsonObj.xlList[i];
								if(xianlObj.xlId == xianluId){
									xianluMc = xianlObj.xlMc;
									$('#dtxl').text(xianlObj.xlMc);
								}
							}
							
							$('#qjzc').text(jsonObj.qjzc == ""?"0":jsonObj.qjzc);
							$('#dgjMc').text(jsonObj.dgjMc);
						} else {
							// errMeg(jsonObj.msg);
						}
						parent.alertMsg.closeLoading();
						//drawPlan(160, 160, 160, 160);
						chuliData();
						
						daoXiang();//导向系统
						
					}
				});
			}

			/**
			 * 展示盾构机项目信息
			 */
			function showData() {
				$.ajax({
					url : "../../webmui/getJqjmData",
					type : "POST",
					data : {
						_model : "3.1",
						appId : appId,
						appSecret : appSecret,
						xmId : xiangmuId,
						tbmId : tbmId,
						dgjId : tbmId,
						xlId : '',
						t:Math.random()
					},
					dataType : 'json',
					success : function(jsonObj) {
						if (jsonObj.success) {
							jsonObj = jsonObj.obj;
							for (i = 0; i < jsonObj.length; i++) {
								var objectData = jsonObj[i];
								if (!in_array(objectData.dwid, teshuField)) {
									var vale = isNaN(objectData.tagvalue)?"0.0":parseFloat(objectData.tagvalue).toFixed(1);
									var values = (vale == 0 ? "0.0" : vale);
									
									if(objectData.dwid == 'TY_TJXT_0004'){
										$('#' + objectData.dwid + '_tag').css('display','block');
									}
									if(objectData.dwid == 'TY_TJXT_0005'){
										$('#' + objectData.dwid + '_tag').css('display','block');
									}
									if(objectData.dwid == 'TY_TJXT_0007'){
										$('#' + objectData.dwid + '_tag').css('display','block');
									}
									
									
									if ($('#' + objectData.dwid).length > 0) {
										$('#' + objectData.dwid).text(values);
									}
									
								} else {
									showTeshuData(objectData);
								}
							}
							$('#TY_DXXT_0001').text(parseInt($('#TY_DXXT_0001').text()));
							$('#huanhao').html(parseInt($('#TY_DXXT_0001').text()));
							showJbxxData();
						} else {
							// errMeg(jsonObj.msg);
						}
					}
				});
			}
		});
